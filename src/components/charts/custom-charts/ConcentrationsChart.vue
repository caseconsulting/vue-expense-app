<template>
  <v-card v-if="dataReceived" class="pa-5">
    <pie-chart
      ref="pieChart"
      chartId="concentrations-chart"
      :key="chartKey"
      :options="option"
      :chartData="chartData"
    ></pie-chart>
  </v-card>
</template>

<script setup>
import PieChart from '../base-charts/PieChart.vue';
import _ from 'lodash';
import { onMounted, onBeforeMount, onBeforeUnmount, ref, inject } from 'vue';

// |--------------------------------------------------|
// |                                                  |
// |                      SETUP                       |
// |                                                  |
// |--------------------------------------------------|

const chartData = ref(null);
const chartKey = ref(0);
const colors = ref([]);
const concentrations = ref(null);
const dataReceived = ref(false);
const degree = ref(null);
const emitter = inject('emitter');
const enabled = ref(false);
const labels = ref([]);
const option = ref(null);
const quantities = ref([]);
const text = ref('');

// |--------------------------------------------------|
// |                                                  |
// |                LIFECYCLE HOOKS                   |
// |                                                  |
// |--------------------------------------------------|

/**
 * Mounted lifecycle hook.
 */
onMounted(async () => {
  // emit comes from HighestDegreeChart.vue when a pie slice is clicked
  await emitter.on('concentrations-update', async (receiveConcentrations) => {
    quantities.value = [];
    labels.value = [];
    dataReceived.value = false;
    degree.value = receiveConcentrations.degree;
    concentrations.value = receiveConcentrations.concentrations;
    await fetchData(concentrations.value);
    await fillData();
  });
}); // mounted

/**
 * Created lifecycle hook.
 */
onBeforeMount(async () => {
  await fetchData(null);
  await fillData();
}); // created

/**
 * Before destroy lifecycle hook.
 */
onBeforeUnmount(() => {
  emitter.off('concentrations-update');
}); // beforeUnmount

// |--------------------------------------------------|
// |                                                  |
// |                      METHODS                     |
// |                                                  |
// |--------------------------------------------------|

/**
 * Gets all the major data.
 *
 * @param concentations - An array of the highest degree concentrations
 */
function fetchData(concentrations) {
  if (concentrations) {
    if (_.isEmpty(concentrations)) {
      text.value = `There are no concentrations for an education of ${degree.value}`;
      quantities.value.push(1);
      enabled.value = false;
      colors.value = ['grey'];
    } else {
      text.value = `${degree.value} Degree Concentrations`;
      enabled.value = true;
      const sortable = Object.entries(concentrations)
        .sort(([, a], [, b]) => b - a)
        .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});

      for (let i = 0; i < 10; i++) {
        let con = Object.keys(sortable)[i];
        if (con) {
          quantities.value.push(sortable[con]);
          labels.value.push(con);
        }
      }
      text.value = `Top ${degree.value} Degree Concentrations`;
      colors.value = [
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(230, 184, 156, 1)',
        'rgba(234, 210, 172, 1)',
        'rgba(156, 175, 183, 1)',
        'rgba(66, 129, 164, 1)'
      ];
    }
  } else {
    // these presets are when a degree has not been selected OR if there are no concentrations
    if (!_.isEmpty(concentrations)) {
      text.value = 'There are no concentrations for this type of degree';
    } else {
      text.value = 'Click on an Education To See Concentrations';
    }
    quantities.value.push(1);
    enabled.value = false;
    colors.value = ['grey'];
  }
} // fetchData

/**
 * Sets up the formatting and data options for the chart.
 */
function fillData() {
  chartData.value = {
    labels: labels.value,
    datasets: [
      {
        data: quantities.value,
        backgroundColor: colors.value
      }
    ]
  };
  option.value = {
    plugins: {
      title: {
        display: true,
        text: text.value,
        font: {
          size: 15
        }
      },
      subtitle: {
        display: true,
        text: enabled.value ? '*Click on a slice to see employees' : '',
        font: {
          style: 'italic'
        }
      },
      tooltip: {
        enabled: enabled.value
      }
    },
    maintainAspectRatio: false
  };
  chartKey.value++; // rerenders the chart
  dataReceived.value = true;
} // fillData
</script>
